# Interbox V2 - Makefile
# Comandos para desenvolvimento, build e deploy (Clerk + Supabase)

.PHONY: help install dev build preview deploy clean lint format test clerk-setup supabase-setup workstation-setup code-standards version build-versioned deploy-versioned env-check

# Vari√°veis
PROJECT_NAME = interbox-landing
NODE_VERSION = 18
PORT = 3002

# Cores para output
RED = \033[0;31m
GREEN = \033[0;32m
YELLOW = \033[1;33m
BLUE = \033[0;34m
PURPLE = \033[0;35m
CYAN = \033[0;36m
WHITE = \033[1;37m
NC = \033[0m # No Color

.DEFAULT_GOAL := help

help: ## Mostra esta ajuda
	@echo "$(CYAN)Interbox Landing - Comandos Dispon√≠veis$(NC)"
	@echo ""
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "$(GREEN)%-20s$(NC) %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""
	@echo "$(YELLOW)Exemplos de uso:$(NC)"
	@echo "  make dev          # Inicia servidor de desenvolvimento"
	@echo "  make build        # Gera build de produ√ß√£o"
	@echo "  make deploy       # Faz deploy na Vercel/Netlify"
	@echo "  make clerk-setup  # Configura Clerk"
	@echo "  make supabase-setup # Configura Supabase"
	@echo "  make env-check    # Verifica vari√°veis de ambiente"
	@echo "  make code-standards # Mostra padr√µes de c√≥digo"
	@echo "  make version      # Gera nova vers√£o automaticamente"
	@echo "  make build-versioned # Build com versionamento autom√°tico"

use-node: ## Garante vers√£o correta do Node
	@echo "$(BLUE)Usando Node $(NODE_VERSION)...$(NC)"
	@which volta >/dev/null 2>&1 && volta install node@$(NODE_VERSION) || true
	@which nvm >/dev/null 2>&1 && . ~/.nvm/nvm.sh && nvm use $(NODE_VERSION) || true

install: ## Instala depend√™ncias
	@echo "$(BLUE)Instalando depend√™ncias...$(NC)"
	npm install
	@echo "$(GREEN)‚úì Depend√™ncias instaladas$(NC)"

dev: ## Inicia servidor de desenvolvimento
	@echo "$(BLUE)Iniciando servidor de desenvolvimento na porta $(PORT)...$(NC)"
	@echo "$(YELLOW)URL: http://localhost:$(PORT)$(NC)"
	npm run dev

build: ## Gera build de produ√ß√£o
	@echo "$(BLUE)Gerando build de produ√ß√£o...$(NC)"
	npm run build
	@echo "$(GREEN)‚úì Build gerado em dist/$(NC)"

build-versioned: ## Gera build com versionamento autom√°tico
	@echo "$(BLUE)Gerando build com versionamento autom√°tico...$(NC)"
	npm run build:versioned
	@echo "$(GREEN)‚úì Build versionado gerado em dist/$(NC)"

build-pwa: ## Gera apenas manifest e sw.js
	@echo "$(BLUE)Buildando Service Worker e manifest...$(NC)"
	npm run build
	@echo "$(GREEN)‚úì PWA gerado$(NC)"

preview: ## Preview do build de produ√ß√£o
	@echo "$(BLUE)Iniciando preview do build...$(NC)"
	npm run preview

deploy: ## Deploy na Vercel/Netlify
	@echo "$(BLUE)Fazendo deploy na Vercel/Netlify...$(NC)"
	npm run deploy

deploy-versioned: ## Deploy com versionamento autom√°tico
	@echo "$(BLUE)Fazendo deploy com versionamento autom√°tico...$(NC)"
	npm run deploy:hosting
	@echo "$(GREEN)‚úì Deploy versionado conclu√≠do$(NC)"

deploy-functions: ## Deploy das Edge Functions do Supabase
	@echo "$(BLUE)Deployando Edge Functions do Supabase...$(NC)"
	npm run deploy:supabase
	@echo "$(GREEN)‚úì Edge Functions deployadas$(NC)"

version: ## Gera nova vers√£o automaticamente
	@echo "$(BLUE)Gerando nova vers√£o automaticamente...$(NC)"
	@echo "$(YELLOW)üìù Vers√£o atual:$(NC)"
	@node -p "require('./package.json').version"
	@echo "$(YELLOW)üîó Git Hash:$(NC)"
	@git rev-parse --short HEAD 2>/dev/null || echo "Git n√£o dispon√≠vel"
	@echo "$(YELLOW)üåø Branch:$(NC)"
	@git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "Git n√£o dispon√≠vel"
	@echo ""
	@echo "$(BLUE)Executando script de versionamento...$(NC)"
	npm run version:build
	@echo "$(GREEN)‚úì Vers√£o gerada automaticamente$(NC)"
	@echo ""
	@echo "$(YELLOW)üìã Informa√ß√µes da nova vers√£o:$(NC)"
	@echo "$(CYAN)Vers√£o:$(NC) $(shell node -p "require('./package.json').version")"
	@echo "$(CYAN)Build ID:$(NC) $(shell node -p "require('./package.json').buildInfo?.buildId || 'N/A'")"
	@echo "$(CYAN)Data:$(NC) $(shell node -p "require('./package.json').buildInfo?.buildDate || 'N/A'")"

version-patch: ## Incrementa vers√£o patch (1.0.0 -> 1.0.1)
	@echo "$(BLUE)Incrementando vers√£o patch...$(NC)"
	npm run version:patch
	@echo "$(GREEN)‚úì Vers√£o patch incrementada$(NC)"

version-minor: ## Incrementa vers√£o minor (1.0.0 -> 1.1.0)
	@echo "$(BLUE)Incrementando vers√£o minor...$(NC)"
	npm run version:minor
	@echo "$(GREEN)‚úì Vers√£o minor incrementada$(NC)"

version-major: ## Incrementa vers√£o major (1.0.0 -> 2.0.0)
	@echo "$(BLUE)Incrementando vers√£o major...$(NC)"
	npm run version:major
	@echo "$(GREEN)‚úì Vers√£o major incrementada$(NC)"

clean: ## Limpa arquivos de build
	@echo "$(BLUE)Limpando arquivos de build...$(NC)"
	rm -rf dist
	rm -rf node_modules/.vite
	@echo "$(GREEN)‚úì Arquivos de build removidos$(NC)"

lint: ## Executa linting do c√≥digo
	@echo "$(BLUE)Executando linting...$(NC)"
	npm run lint
	@echo "$(GREEN)‚úì Linting conclu√≠do$(NC)"

format: ## Formata c√≥digo automaticamente
	@echo "$(BLUE)Formatando c√≥digo...$(NC)"
	npx prettier --write "src/**/*.{ts,tsx,js,jsx,json,css,md}"
	@echo "$(GREEN)‚úì C√≥digo formatado$(NC)"

test: ## Executa testes
	@echo "$(BLUE)Executando testes...$(NC)"
	npm test
	@echo "$(GREEN)‚úì Testes conclu√≠dos$(NC)"

test-watch: ## Executa testes em modo watch
	@echo "$(BLUE)Executando testes em modo watch...$(NC)"
	npm run test:watch

test-coverage: ## Executa testes com cobertura
	@echo "$(BLUE)Executando testes com cobertura...$(NC)"
	npm run test:coverage
	@echo "$(GREEN)‚úì Cobertura de testes gerada$(NC)"

clerk-setup: ## Configura Clerk
	@echo "$(BLUE)Configurando Clerk...$(NC)"
	@echo "$(YELLOW)1. Acesse: https://clerk.com$(NC)"
	@echo "$(YELLOW)2. Crie uma nova aplica√ß√£o$(NC)"
	@echo "$(YELLOW)3. Copie a Publishable Key$(NC)"
	@echo "$(YELLOW)4. Adicione ao arquivo .env$(NC)"
	@echo "$(GREEN)‚úì Clerk configurado$(NC)"

supabase-setup: ## Configura Supabase
	@echo "$(BLUE)Configurando Supabase...$(NC)"
	@echo "$(YELLOW)1. Acesse: https://supabase.com$(NC)"
	@echo "$(YELLOW)2. Crie um novo projeto$(NC)"
	@echo "$(YELLOW)3. Copie a URL e anon key$(NC)"
	@echo "$(YELLOW)4. Adicione ao arquivo .env$(NC)"
	@echo "$(GREEN)‚úì Supabase configurado$(NC)"

workstation-setup: ## Configura workstation de desenvolvimento
	@echo "$(BLUE)Configurando workstation...$(NC)"
	@echo "$(YELLOW)Instalando depend√™ncias globais...$(NC)"
	npm install -g @vitejs/plugin-react
	npm install -g supabase
	@echo "$(GREEN)‚úì Workstation configurada$(NC)"

code-standards: ## Mostra padr√µes de c√≥digo
	@echo "$(CYAN)üìã Padr√µes de C√≥digo INTERB√òX V2 2025$(NC)"
	@echo "$(YELLOW)====================================$(NC)"
	@echo ""
	@echo "$(WHITE)üéØ Estrutura de Arquivos:$(NC)"
	@echo "  src/components/     - Componentes React"
	@echo "  src/pages/          - P√°ginas da aplica√ß√£o"
	@echo "  src/hooks/          - Hooks customizados (useAuth, usePermissions)"
	@echo "  src/types/          - Defini√ß√µes de tipos TypeScript"
	@echo "  src/utils/          - Utilit√°rios e helpers"
	@echo "  src/lib/            - Configura√ß√µes (clerk.ts, supabase.ts)"
	@echo ""
	@echo "$(WHITE)üîß Conven√ß√µes:$(NC)"
	@echo "  - Nomes de arquivos: PascalCase para componentes, camelCase para outros"
	@echo "  - Nomes de vari√°veis: camelCase"
	@echo "  - Nomes de componentes: PascalCase"
	@echo "  - Nomes de fun√ß√µes: camelCase"
	@echo "  - Nomes de constantes: UPPER_SNAKE_CASE"
	@echo ""
	@echo "$(WHITE)üîê Autentica√ß√£o (Clerk):$(NC)"
	@echo "  - USE: SignedIn, SignedOut, UserButton, SignInButton"
	@echo "  - USE: useAuth(), useRole()"
	@echo "  - N√ÉO USE: Firebase Auth"
	@echo "  - Implemente rotas protegidas com ProtectedRoute"
	@echo ""
	@echo "$(WHITE)üóÑÔ∏è Banco de Dados (Supabase):$(NC)"
	@echo "  - USE: supabase client das fun√ß√µes em src/lib/supabase.ts"
	@echo "  - USE: Tipos gerados automaticamente em src/types/supabase.ts"
	@echo "  - N√ÉO USE: Firestore"
	@echo "  - Sincronize dados do usu√°rio Clerk com Supabase"
	@echo ""
	@echo "$(WHITE)üìù Coment√°rios:$(NC)"
	@echo "  - Use coment√°rios para explicar l√≥gica complexa"
	@echo "  - Documente fun√ß√µes p√∫blicas com JSDoc"
	@echo "  - Mantenha coment√°rios atualizados"
	@echo ""
	@echo "$(WHITE)üöÄ Performance:$(NC)"
	@echo "  - Use React.memo para componentes pesados"
	@echo "  - Implemente lazy loading para rotas"
	@echo "  - Otimize re-renders com useCallback e useMemo"
	@echo ""
	@echo "$(WHITE)üõ°Ô∏è Seguran√ßa:$(NC)"
	@echo "  - Valide inputs do usu√°rio"
	@echo "  - Use HTTPS em produ√ß√£o"
	@echo "  - Implemente autentica√ß√£o com Clerk"
	@echo "  - Use RLS (Row Level Security) no Supabase"
	@echo ""
	@echo "$(WHITE)üß™ Testes:$(NC)"
	@echo "  - Escreva testes para l√≥gica de neg√≥cio"
	@echo "  - Use Jest para testes unit√°rios"
	@echo "  - Use Playwright para testes E2E"

# Comandos de desenvolvimento r√°pido
dev-fast: ## Desenvolvimento r√°pido sem otimiza√ß√µes
	@echo "$(BLUE)Iniciando desenvolvimento r√°pido...$(NC)"
	NODE_ENV=development npm run dev

build-fast: ## Build r√°pido para desenvolvimento
	@echo "$(BLUE)Build r√°pido para desenvolvimento...$(NC)"
	NODE_ENV=development npm run build

# Comandos de deploy espec√≠ficos
deploy-staging: ## Deploy para ambiente de staging
	@echo "$(BLUE)Deploy para staging...$(NC)"
	@echo "$(YELLOW)Configurando ambiente de staging...$(NC)"
	make deploy-versioned

deploy-production: ## Deploy para produ√ß√£o
	@echo "$(BLUE)Deploy para produ√ß√£o...$(NC)"
	@echo "$(YELLOW)Configurando ambiente de produ√ß√£o...$(NC)"
	make deploy-versioned

# Comandos de monitoramento
logs: ## Mostra logs do Supabase
	@echo "$(BLUE)Mostrando logs do Supabase...$(NC)"
	@echo "$(YELLOW)Logs dispon√≠veis no dashboard do Supabase$(NC)"
	@echo "$(CYAN)URL: https://app.supabase.com$(NC)"

# Comandos espec√≠ficos para Clerk + Supabase
env-check: ## Verifica vari√°veis de ambiente
	@echo "$(BLUE)Verificando vari√°veis de ambiente...$(NC)"
	@if [ -f .env ]; then \
		echo "$(GREEN)‚úì Arquivo .env encontrado$(NC)"; \
		echo "$(YELLOW)Vari√°veis configuradas:$(NC)"; \
		grep -E "^(VITE_CLERK_|VITE_SUPABASE_URL|VITE_SUPABASE_ANON_KEY)" .env | sed 's/=.*/=***/' || echo "$(RED)‚úó Nenhuma vari√°vel encontrada$(NC)"; \
	else \
		echo "$(RED)‚úó Arquivo .env n√£o encontrado$(NC)"; \
		echo "$(YELLOW)Execute: cp env.example .env$(NC)"; \
	fi

clerk-status: ## Status da aplica√ß√£o Clerk
	@echo "$(BLUE)Verificando status do Clerk...$(NC)"
	@node scripts/force-production.js

clerk-force-production: ## For√ßa modo production do Clerk
	@echo "$(BLUE)For√ßando modo production do Clerk...$(NC)"
	@node scripts/force-production.js
	@echo "$(GREEN)‚úì Modo production verificado$(NC)"

clerk-dev-setup: ## Configura Clerk para desenvolvimento local
	@echo "$(BLUE)Configurando Clerk para desenvolvimento...$(NC)"
	@if [ -f env.local.example ]; then \
		cp env.local.example .env.local; \
		echo "$(YELLOW)Arquivo .env.local criado. Configure as chaves de TESTE$(NC)"; \
	else \
		echo "$(RED)Arquivo env.local.example n√£o encontrado$(NC)"; \
	fi
	@echo "$(GREEN)‚úì Configura√ß√£o de desenvolvimento criada$(NC)"

clerk-env-switch: ## Alterna entre ambiente de desenvolvimento e produ√ß√£o
	@echo "$(BLUE)Alternando ambiente do Clerk...$(NC)"
	@node scripts/force-production.js
	@echo "$(YELLOW)Para desenvolvimento: npm run dev$(NC)"
	@echo "$(YELLOW)Para produ√ß√£o: npm run build && npm run preview$(NC)"
	@echo "$(BLUE)Verificando status do Clerk...$(NC)"
	@if grep -q "VITE_CLERK_PUBLISHABLE_KEY" .env 2>/dev/null; then \
		echo "$(GREEN)‚úì Clerk configurado$(NC)"; \
	else \
		echo "$(RED)‚úó Clerk n√£o configurado$(NC)"; \
		echo "$(YELLOW)Execute: make clerk-setup$(NC)"; \
	fi

supabase-status: ## Status da aplica√ß√£o Supabase
	@echo "$(BLUE)Verificando status do Supabase...$(NC)"
	@if grep -q "VITE_SUPABASE_URL" .env 2>/dev/null && grep -q "VITE_SUPABASE_ANON_KEY" .env 2>/dev/null; then \
		echo "$(GREEN)‚úì Supabase configurado$(NC)"; \
		echo "$(YELLOW)URL: $(shell grep VITE_SUPABASE_URL .env | cut -d'=' -f2)$(NC)"; \
	else \
		echo "$(RED)‚úó Supabase n√£o configurado$(NC)"; \
		echo "$(YELLOW)Execute: make supabase-setup$(NC)"; \
	fi

db-migrate: ## Executa migra√ß√µes do banco
	@echo "$(BLUE)Executando migra√ß√µes do banco...$(NC)"
	@if command -v supabase >/dev/null 2>&1; then \
		supabase db push; \
		echo "$(GREEN)‚úì Migra√ß√µes executadas$(NC)"; \
	else \
		echo "$(RED)‚úó Supabase CLI n√£o instalado$(NC)"; \
		echo "$(YELLOW)Execute: make workstation-setup$(NC)"; \
	fi

db-reset: ## Reseta o banco de dados
	@echo "$(BLUE)Resetando banco de dados...$(NC)"
	@if command -v supabase >/dev/null 2>&1; then \
		supabase db reset; \
		echo "$(GREEN)‚úì Banco resetado$(NC)"; \
	else \
		echo "$(RED)‚úó Supabase CLI n√£o instalado$(NC)"; \
		echo "$(YELLOW)Execute: make workstation-setup$(NC)"; \
	fi

status: ## Status do projeto
	@echo "$(CYAN)üìä Status do Projeto INTERB√òX V2 2025$(NC)"
	@echo "$(YELLOW)====================================$(NC)"
	@echo "$(WHITE)Vers√£o:$(NC) $(shell node -p "require('./package.json').version")"
	@echo "$(WHITE)Build:$(NC) $(shell node -p "require('./package.json').buildInfo?.buildDate || 'N/A'")"
	@echo "$(WHITE)Git Hash:$(NC) $(shell git rev-parse --short HEAD 2>/dev/null || echo 'N/A')"
	@echo "$(WHITE)Branch:$(NC) $(shell git rev-parse --abbrev-ref HEAD 2>/dev/null || echo 'N/A')"
	@echo "$(WHITE)√öltimo Commit:$(NC) $(shell git log -1 --pretty=format:%s 2>/dev/null || echo 'N/A')"
